{{- if .Values.backend.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pganalytics.fullname" . }}-backend-config
  namespace: {{ include "pganalytics.namespace" . }}
  labels:
    {{- include "pganalytics.labels" . | nindent 4 }}
    app.kubernetes.io/component: backend
data:
  # Logging configuration
  LOG_LEVEL: {{ .Values.logging.level | quote }}
  LOG_FORMAT: {{ .Values.logging.format | quote }}

  # API configuration
  API_BIND_ADDR: "0.0.0.0:8080"
  API_WORKERS: {{ .Values.backend.env | default "4" | quote }}

  # CORS configuration
  CORS_ENABLED: {{ .Values.features.corsWhitelisting | quote }}
  CORS_ORIGINS: "http://localhost:3000,https://{{ .Values.global.domain }}"
  CORS_ALLOWED_METHODS: "GET,POST,PUT,DELETE,OPTIONS"
  CORS_ALLOWED_HEADERS: "Content-Type,Authorization"
  CORS_ALLOW_CREDENTIALS: "true"
  CORS_MAX_AGE: "3600"

  # Database configuration
  DB_HOST: {{ include "pganalytics.database.host" . | quote }}
  DB_PORT: "5432"
  DB_NAME: "pganalytics"
  DB_SSLMODE: "disable"
  DB_MAX_OPEN_CONNS: "25"
  DB_MAX_IDLE_CONNS: "5"
  DB_CONN_MAX_LIFETIME: "5m"

  # Redis configuration
  REDIS_HOST: {{ include "pganalytics.redis.host" . | quote }}
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_MAX_RETRIES: "3"

  # Authentication
  JWT_EXPIRATION: "24h"
  JWT_REFRESH_EXPIRATION: "7d"
  AUTH_BCRYPT_COST: "12"

  # Features
  ANOMALY_DETECTION_ENABLED: {{ .Values.features.anomalyDetection | quote }}
  TOKEN_BLACKLIST_ENABLED: {{ .Values.features.tokenBlacklist | quote }}
  ADVANCED_AUTH_ENABLED: {{ .Values.features.advancedAuth | quote }}

  # Monitoring
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  PROFILING_ENABLED: "false"

  # TLS
  TLS_ENABLED: {{ .Values.global.tls.enabled | quote }}
  TLS_CERT_PATH: "/etc/pganalytics/certs/tls.crt"
  TLS_KEY_PATH: "/etc/pganalytics/certs/tls.key"

---
{{- end }}
{{- if .Values.collector.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pganalytics.fullname" . }}-collector-config
  namespace: {{ include "pganalytics.namespace" . }}
  labels:
    {{- include "pganalytics.labels" . | nindent 4 }}
    app.kubernetes.io/component: collector
data:
  # Logging configuration
  LOG_LEVEL: {{ .Values.logging.level | quote }}
  LOG_FORMAT: {{ .Values.logging.format | quote }}

  # Collector configuration
  COLLECTOR_INTERVAL: "60"
  COLLECTOR_TIMEOUT: "30s"
  METRICS_BATCH_SIZE: "100"
  BUFFER_SIZE_MB: "50"
  MAX_RETRIES: "3"
  RETRY_INTERVAL: "5s"

  # Compression
  COMPRESSION: "gzip"
  COMPRESSION_LEVEL: "6"

  # API configuration
  API_ENDPOINT: {{ include "pganalytics.backend.endpoint" . | quote }}
  API_TIMEOUT: "30s"
  API_VERIFY_TLS: "false"

  # Database queries
  QUERY_LIMIT: "100"
  QUERY_TIMEOUT: "30s"
  EXCLUDE_SYSTEM_QUERIES: "true"

  # Metrics
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"

  # Node information
  NODE_NAME_FROM_ENV: "true"
  POD_NAME_FROM_ENV: "true"
  POD_NAMESPACE_FROM_ENV: "true"

---
{{- end }}
{{- if .Values.postgresql.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pganalytics.fullname" . }}-postgresql-config
  namespace: {{ include "pganalytics.namespace" . }}
  labels:
    {{- include "pganalytics.labels" . | nindent 4 }}
    app.kubernetes.io/component: postgresql
data:
  postgresql.conf: |
    # PostgreSQL Configuration for pgAnalytics
    # Generated by Helm Chart v3.3.0

    # Connection settings
    max_connections = 100
    superuser_reserved_connections = 5

    # Memory settings
    shared_buffers = 256MB
    effective_cache_size = 1GB
    work_mem = 16MB
    maintenance_work_mem = 64MB

    # WAL configuration
    wal_level = replica
    max_wal_senders = 3
    max_replication_slots = 3
    wal_keep_segments = 64

    # Logging
    log_min_duration_statement = 1000
    log_statement = 'all'
    log_connections = on
    log_disconnections = on
    log_duration = off
    log_lock_waits = on
    log_replication_commands = on

    # Performance
    random_page_cost = 1.1
    effective_io_concurrency = 200
    default_statistics_target = 100

    # Extensions
    shared_preload_libraries = 'timescaledb'

---
{{- end }}
{{- if .Values.grafana.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pganalytics.fullname" . }}-grafana-provisioning
  namespace: {{ include "pganalytics.namespace" . }}
  labels:
    {{- include "pganalytics.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: PostgreSQL
        type: postgres
        access: proxy
        url: {{ include "pganalytics.database.host" . }}:5432
        database: pganalytics
        user: pganalytics
        secureJsonData:
          password: ${POSTGRES_PASSWORD}
        isDefault: true
        editable: true

      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: false
        editable: true

{{- end }}
