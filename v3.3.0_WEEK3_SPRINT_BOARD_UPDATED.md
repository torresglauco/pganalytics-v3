# pgAnalytics v3.3.0 - Week 3 Sprint Board (UPDATED)

**Sprint**: Week 3 (January 16-20, 2026)
**Phase**: Enterprise Authentication, Encryption & System Metrics
**Duration**: 40 hours (5 days Ã— 8 hours) + 45 hours system metrics
**Team Size**: 4 developers (2 Backend, 1 DevOps, 1 QA)
**Total Effort**: 140 hours (95 auth/crypto + 45 system metrics)
**Status**: ðŸš€ READY TO EXECUTE

---

## Sprint Overview

Week 3 focuses on implementing enterprise-grade authentication, encryption features, AND critical system metrics collection. This sprint enables organizations to:
1. Integrate with existing identity management systems (LDAP, SAML, OAuth 2.0)
2. Encrypt sensitive data at rest
3. Monitor system-level performance (CPU, Memory, Disk, Network)

### Business Value
- **Revenue Impact**: $3.5M-$4.8M annual (enterprise features)
- **Market Opportunity**: 500+ enterprise customers
- **Competitive Advantage**: GDPR, HIPAA, SOX, PCI-DSS compliance + system monitoring
- **Technical Foundation**: Enables production-grade monitoring

### Sprint Goals
1. âœ… LDAP authentication fully integrated
2. âœ… SAML 2.0 SSO with multiple identity providers
3. âœ… OAuth 2.0 (Google, GitHub, Okta)
4. âœ… Encryption at rest for sensitive data
5. âœ… MFA (multi-factor authentication)
6. âœ… **NEW**: System metrics collection (CPU, Memory, Disk, Network)
7. âœ… **NEW**: System metrics dashboards in Grafana
8. âœ… All tests passing with >90% coverage
9. âœ… Complete documentation

---

## Sprint Schedule

### Daily Standup
- **Time**: 10:00 UTC (15 minutes)
- **Location**: Slack #pganalytics-v330-dev

### Mid-Week Sync
- **Time**: Wednesday 14:00 UTC (30 minutes)
- **Topics**: Progress, blockers, adjustments

### Week-End Review
- **Time**: Friday 16:00 UTC (1 hour)
- **Deliverables**: Demo, metrics, risks, next week prep

---

## Epic 1: Enterprise LDAP Integration (35 hours)

**Objective**: Integrate LDAP directory services for enterprise user management
**Assignee**: Backend Engineer #1
**Hours**: 35

### Task 3.1.1: LDAP Client Library (8 hours)
- Research & evaluate LDAP libraries (2h)
- LDAP client implementation (6h)

**Deliverable**: `backend/internal/auth/ldap/client.go`

### Task 3.1.2: LDAP Auth Service (10 hours)
- User authentication handler (4h)
- Auto-user registration (3h)
- Group-to-role mapping (3h)

**Deliverable**: `backend/internal/auth/service_ldap.go`

### Task 3.1.3: Config & Scheduler (8 hours)
- LDAP configuration management (3h)
- Automatic sync scheduler (5h)

**Deliverable**: `backend/internal/auth/ldap/sync.go`

### Task 3.1.4: Testing & Docs (9 hours)
- Integration tests (5h)
- Documentation (4h)

**Deliverable**: `docs/LDAP_INTEGRATION.md` (2000+ words)

---

## Epic 2: SAML 2.0 & OAuth 2.0 (40 hours)

**Objective**: Enable SSO with SAML 2.0 and OAuth 2.0 providers
**Assignee**: Backend Engineer #1
**Hours**: 40

### Task 3.2.1: SAML 2.0 Implementation (20 hours)
- SAML library setup (10h)
- SAML flow implementation (10h)

**Deliverable**: `backend/internal/auth/saml/saml.go`

### Task 3.2.2: OAuth 2.0 Providers (15 hours)
- Google OAuth provider (5h)
- GitHub OAuth provider (5h)
- Okta OAuth provider (5h)

**Deliverable**: `backend/internal/auth/oauth/providers.go`

### Task 3.2.3: Testing & Documentation (5 hours)
- Integration tests (3h)
- Documentation (2h)

**Deliverable**: `docs/SAML_INTEGRATION.md` + `docs/OAUTH_INTEGRATION.md`

---

## Epic 3: Encryption at Rest & MFA (20 hours)

**Objective**: Implement encryption and multi-factor authentication
**Assignee**: Backend Engineer #2
**Hours**: 20

### Task 3.3.1: Encryption Library (8 hours)
- AES-256-GCM implementation (4h)
- Key management (4h)

**Deliverable**: `backend/internal/crypto/encryptor.go`

### Task 3.3.2: Database Integration (5 hours)
- Schema migration (2h)
- Model encryption (3h)

**Deliverable**: `backend/migrations/003_add_encryption.sql`

### Task 3.3.3: MFA & Token Blacklist (7 hours)
- TOTP implementation (3h)
- Token blacklist (2h)
- Testing (2h)

**Deliverable**: `backend/internal/auth/mfa/totp.go`

---

## ðŸ†• Epic 4: System Metrics Collection (45 hours) - CRITICAL

**Objective**: Collect system-level performance metrics (CPU, Memory, Disk, Network)
**Status**: ðŸ”´ CRITICAL PRIORITY
**Team**: Backend Engineer #2 + DevOps Engineer
**Hours**: 45

### Context
Community pganalytics has 33 critical system metrics. These are essential for production monitoring and are currently missing from v3.3.0.

---

### Task 3.4.1: CPU Metrics Collection (8 hours)

**Objective**: Collect CPU usage metrics from all cores
**Assignee**: Backend Engineer #2
**Hours**: 8

#### Subtask 3.4.1.1: CPU Data Source Implementation (3 hours)

**Work**:
1. Read /proc/stat for Linux
2. Parse CPU metrics:
   - User time %
   - System time %
   - I/O wait %
   - Steal time %
   - Idle time %
   - Nice time %
   - Per-CPU breakdown

**File**: `backend/internal/metrics/cpu.go`

```go
package metrics

import (
    "bufio"
    "os"
    "strconv"
    "strings"
    "sync"
    "time"
)

type CPUMetric struct {
    CPU        int       // CPU number (or -1 for total)
    UserTime   float64   // User mode time %
    SystemTime float64   // System mode time %
    IOWait     float64   // I/O wait time %
    StealTime  float64   // Stolen time %
    IdleTime   float64   // Idle time %
    NiceTime   float64   // Nice time %
    Timestamp  time.Time
}

type CPUCollector struct {
    mu         sync.RWMutex
    lastStats  map[int]CPUStats
    interval   time.Duration
}

type CPUStats struct {
    User   uint64
    Nice   uint64
    System uint64
    Idle   uint64
    Iowait uint64
    Steal  uint64
    Guest  uint64
    Irq    uint64
    Softirq uint64
}

func (c *CPUCollector) CollectCPUMetrics() ([]*CPUMetric, error) {
    file, err := os.Open("/proc/stat")
    if err != nil {
        return nil, err
    }
    defer file.Close()

    scanner := bufio.NewScanner(file)
    metrics := []*CPUMetric{}

    for scanner.Scan() {
        line := scanner.Text()
        if !strings.HasPrefix(line, "cpu") {
            continue
        }

        fields := strings.Fields(line)
        if len(fields) < 5 {
            continue
        }

        cpu := -1
        if len(fields[0]) > 3 {
            cpuStr := fields[0][3:]
            if cpuNum, err := strconv.Atoi(cpuStr); err == nil {
                cpu = cpuNum
            }
        }

        // Parse CPU stats and calculate percentages
        metric := calculateCPUPercentages(fields, cpu)
        if metric != nil {
            metrics = append(metrics, metric)
        }
    }

    return metrics, nil
}

func calculateCPUPercentages(fields []string, cpu int) *CPUMetric {
    // Extract values
    user, _ := strconv.ParseUint(fields[1], 10, 64)
    nice, _ := strconv.ParseUint(fields[2], 10, 64)
    system, _ := strconv.ParseUint(fields[3], 10, 64)
    idle, _ := strconv.ParseUint(fields[4], 10, 64)
    iowait, _ := strconv.ParseUint(fields[5], 10, 64)
    steal := uint64(0)
    if len(fields) > 8 {
        steal, _ = strconv.ParseUint(fields[8], 10, 64)
    }

    total := user + nice + system + idle + iowait + steal
    if total == 0 {
        return nil
    }

    return &CPUMetric{
        CPU:        cpu,
        UserTime:   float64(user) / float64(total) * 100,
        SystemTime: float64(system) / float64(total) * 100,
        IOWait:     float64(iowait) / float64(total) * 100,
        StealTime:  float64(steal) / float64(total) * 100,
        IdleTime:   float64(idle) / float64(total) * 100,
        NiceTime:   float64(nice) / float64(total) * 100,
        Timestamp:  time.Now(),
    }
}
```

#### Subtask 3.4.1.2: Database Storage (2 hours)

**Schema**:
```sql
CREATE TABLE sn_sysstat_cpu (
    snap_id INTEGER DEFAULT currval('sn_stat_snapshot_seq'::regclass) NOT NULL,
    hostname TEXT NOT NULL,
    interval INTEGER NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    cpu INTEGER NOT NULL,  -- -1 for total, 0-N for per-CPU
    user_time DECIMAL(5,2) NOT NULL,
    system_time DECIMAL(5,2) NOT NULL,
    iowait DECIMAL(5,2),
    steal_time DECIMAL(5,2),
    idle_time DECIMAL(5,2) NOT NULL,
    nice_time DECIMAL(5,2),
    PRIMARY KEY (snap_id, cpu, timestamp)
);

CREATE INDEX idx_sysstat_cpu_timestamp ON sn_sysstat_cpu(timestamp DESC);
CREATE INDEX idx_sysstat_cpu_hostname ON sn_sysstat_cpu(hostname);
```

**File**: `backend/migrations/system_metrics_001_cpu.sql`

#### Subtask 3.4.1.3: Integration & Testing (3 hours)

**Work**:
- Integration with metrics collection loop
- Unit tests
- Performance verification

**File**: `backend/tests/metrics/cpu_test.go`

---

### Task 3.4.2: Memory Metrics Collection (8 hours)

**Objective**: Collect memory usage metrics
**Assignee**: Backend Engineer #2
**Hours**: 8

#### Subtask 3.4.2.1: Memory Data Source (3 hours)

**Metrics from /proc/meminfo**:
- Free memory
- Used memory
- Memory usage %
- Buffers
- Cached memory
- Committed memory
- Commit %
- Active memory
- Inactive memory

**File**: `backend/internal/metrics/memory.go`

#### Subtask 3.4.2.2: Database Schema (2 hours)

**Schema**:
```sql
CREATE TABLE sn_sysstat_memusage (
    snap_id INTEGER DEFAULT currval('sn_stat_snapshot_seq'::regclass) NOT NULL,
    hostname TEXT NOT NULL,
    interval INTEGER NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    kbmemfree DECIMAL(12,2) NOT NULL,
    kbmemused DECIMAL(12,2) NOT NULL,
    memused_percent DECIMAL(5,2) NOT NULL,
    kbbuffers DECIMAL(12,2),
    kbcached DECIMAL(12,2) NOT NULL,
    kbcommit DECIMAL(12,2) NOT NULL,
    commit_percent DECIMAL(5,2) NOT NULL,
    kbactive DECIMAL(12,2),
    kbinact DECIMAL(12,2),
    PRIMARY KEY (snap_id, timestamp)
);

CREATE INDEX idx_sysstat_memusage_timestamp ON sn_sysstat_memusage(timestamp DESC);
```

**File**: `backend/migrations/system_metrics_002_memory.sql`

#### Subtask 3.4.2.3: Testing (3 hours)

**File**: `backend/tests/metrics/memory_test.go`

---

### Task 3.4.3: Disk I/O Metrics (10 hours)

**Objective**: Collect disk I/O performance metrics
**Assignee**: DevOps Engineer
**Hours**: 10

#### Subtask 3.4.3.1: Disk I/O Data Source (4 hours)

**Metrics from /proc/diskstats**:
- Transactions per second (TPS)
- Read rate (KB/s)
- Write rate (KB/s)
- Average request size
- Average queue size
- Average wait time
- Read wait time
- Write wait time
- Service time
- Utilization %

**File**: `backend/internal/metrics/diskio.go`

#### Subtask 3.4.3.2: Database Schema (2 hours)

**Schema**:
```sql
CREATE TABLE sn_sysstat_disks (
    snap_id INTEGER DEFAULT currval('sn_stat_snapshot_seq'::regclass) NOT NULL,
    hostname TEXT NOT NULL,
    device TEXT NOT NULL,
    interval INTEGER NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    tps DECIMAL(8,2) NOT NULL,
    rd_sec_s DECIMAL(10,2) NOT NULL,
    wr_sec_s DECIMAL(10,2) NOT NULL,
    avgrq_sz DECIMAL(8,2),
    avgqu_sz DECIMAL(8,2),
    await DECIMAL(8,2),
    r_await DECIMAL(8,2),
    w_await DECIMAL(8,2),
    svctm DECIMAL(8,2),
    util_percent DECIMAL(5,2),
    PRIMARY KEY (snap_id, device, timestamp)
);

CREATE INDEX idx_sysstat_disks_timestamp ON sn_sysstat_disks(timestamp DESC);
CREATE INDEX idx_sysstat_disks_device ON sn_sysstat_disks(device);
```

**File**: `backend/migrations/system_metrics_003_diskio.sql`

#### Subtask 3.4.3.3: Testing (4 hours)

**File**: `backend/tests/metrics/diskio_test.go`

---

### Task 3.4.4: Network Metrics Collection (8 hours)

**Objective**: Collect network interface performance metrics
**Assignee**: DevOps Engineer
**Hours**: 8

#### Subtask 3.4.4.1: Network Data Source (3 hours)

**Metrics from /proc/net/dev**:
- Packets received/sec
- Packets transmitted/sec
- KB received/sec
- KB transmitted/sec
- Compressed packets/sec
- Multicast packets/sec
- Network errors

**File**: `backend/internal/metrics/network.go`

#### Subtask 3.4.4.2: Database Schema (2 hours)

**Schema**:
```sql
CREATE TABLE sn_sysstat_network (
    snap_id INTEGER DEFAULT currval('sn_stat_snapshot_seq'::regclass) NOT NULL,
    hostname TEXT NOT NULL,
    iface TEXT NOT NULL,
    interval INTEGER NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    rxpck_s DECIMAL(10,2),
    txpck_s DECIMAL(10,2),
    rxkb_s DECIMAL(10,2),
    txkb_s DECIMAL(10,2),
    rxcmp_s DECIMAL(10,2),
    txcmp_s DECIMAL(10,2),
    rxmcst_s DECIMAL(10,2),
    errors INTEGER,
    dropped INTEGER,
    PRIMARY KEY (snap_id, iface, timestamp)
);

CREATE INDEX idx_sysstat_network_timestamp ON sn_sysstat_network(timestamp DESC);
CREATE INDEX idx_sysstat_network_iface ON sn_sysstat_network(iface);
```

**File**: `backend/migrations/system_metrics_004_network.sql`

#### Subtask 3.4.4.3: Testing (3 hours)

**File**: `backend/tests/metrics/network_test.go`

---

### Task 3.4.5: Grafana System Dashboards (11 hours)

**Objective**: Create comprehensive system monitoring dashboards
**Assignee**: DevOps Engineer
**Hours**: 11

#### Subtask 3.4.5.1: System Overview Dashboard (4 hours)

**Panels**:
- CPU usage (overall + per-CPU)
- Memory usage (total, buffers, cached)
- Disk I/O (TPS, read/write rates)
- Network bandwidth (in/out)

**File**: `grafana/dashboards/system-overview.json`

#### Subtask 3.4.5.2: CPU & Load Dashboard (3 hours)

**Panels**:
- User/System/IOWait time
- CPU utilization per core
- Load average
- Context switches

**File**: `grafana/dashboards/cpu-analysis.json`

#### Subtask 3.4.5.3: Memory & Disk Dashboard (4 hours)

**Panels**:
- Memory distribution (free, buffers, cached, used)
- Swap usage
- Disk I/O performance
- Queue depth and latency

**File**: `grafana/dashboards/memory-disk-analysis.json`

---

## Epic 4 Summary

| Task | Hours | Deliverables | Status |
|------|-------|--------------|--------|
| 3.4.1 CPU Metrics | 8 | cpu.go, schema, tests | Pending |
| 3.4.2 Memory Metrics | 8 | memory.go, schema, tests | Pending |
| 3.4.3 Disk I/O Metrics | 10 | diskio.go, schema, tests | Pending |
| 3.4.4 Network Metrics | 8 | network.go, schema, tests | Pending |
| 3.4.5 Grafana Dashboards | 11 | 3 dashboards | Pending |
| **Total** | **45** | **20 files** | **Pending** |

---

## Success Metrics

### Code Quality
- âœ… Test coverage >90%
- âœ… Zero security vulnerabilities
- âœ… All linting checks pass
- âœ… Code review approved

### Performance
- âœ… Auth response <200ms
- âœ… Encryption <1ms per field
- âœ… LDAP sync <5s for 1000 users
- âœ… System metrics collection <1s per cycle
- âœ… No memory leaks

### Functionality
- âœ… LDAP fully integrated
- âœ… SAML 2.0 working
- âœ… OAuth 2.0 working
- âœ… Encryption at rest working
- âœ… MFA working
- âœ… **NEW**: CPU metrics collected
- âœ… **NEW**: Memory metrics collected
- âœ… **NEW**: Disk I/O metrics collected
- âœ… **NEW**: Network metrics collected
- âœ… **NEW**: System dashboards created

---

## Team Assignments

### Backend Engineer #1 (75 hours)
- LDAP integration (35h)
- SAML/OAuth (40h)

### Backend Engineer #2 (50 hours)
- Encryption/MFA (20h)
- CPU metrics (8h)
- Memory metrics (8h)
- Disk I/O (optional assist) (4h)
- Testing & debugging (10h)

### DevOps Engineer (15 hours)
- Disk I/O metrics (10h)
- Network metrics (8h)
- Grafana dashboards (11h)
- CI/CD pipeline updates (1h)
- **Total**: 30 hours (increased from 5h)

### QA Engineer (15 hours)
- Auth testing (8h)
- System metrics testing (7h)

**Total Effort**: 140 hours (was 95h, now +45h for system metrics)

---

## Critical Dependencies

### Pre-Sprint Requirements
- âœ… Week 2 HA/LB complete
- âœ… Backend stateless
- âœ… Redis session storage
- âœ… Database migrations ready

### System Metrics Dependencies
- âœ… Linux /proc filesystem access
- âœ… libsysstat or custom parser
- âœ… Grafana datasource configured
- âœ… Database migration capability

---

## Risk Assessment & Mitigation

### Risk: System Metrics Collection Performance
**Severity**: HIGH
**Impact**: Metrics collection could consume CPU/memory
**Mitigation**:
- Profile in staging environment
- Set collection interval to 60 seconds
- Implement background goroutines
- Monitor resource usage

### Risk: /proc Filesystem Availability
**Severity**: MEDIUM
**Impact**: Not all systems have /proc
**Mitigation**:
- Implement fallback to sysstat commands
- Support macOS/Windows through platform-specific code
- Test on all supported platforms

### Risk: Grafana Dashboard Complexity
**Severity**: LOW
**Impact**: Difficult to understand system metrics
**Mitigation**:
- Create documented dashboards
- Include drill-down capabilities
- Provide dashboard templates

---

## Week 3 Execution Timeline

### Monday Jan 16
- Kickoff (10:00 UTC)
- LDAP research & client start
- Memory metrics implementation start

### Tuesday Jan 17
- LDAP client complete
- CPU metrics complete
- SAML library setup

### Wednesday Jan 18
- LDAP auth service complete
- Memory metrics complete
- SAML configuration
- Mid-week sync (14:00 UTC)

### Thursday Jan 19
- OAuth implementation complete
- Disk I/O metrics complete
- Encryption complete
- Network metrics implementation

### Friday Jan 20
- Network metrics complete
- Grafana dashboards complete
- Integration & end-to-end tests
- Week-end review (16:00 UTC)

---

## Success Criteria for Week 3

### Before Week 4 Starts
- [ ] All 140 hours completed
- [ ] 95+ auth/crypto metrics integrated
- [ ] 33+ system metrics collected
- [ ] 3 Grafana system dashboards created
- [ ] All tests passing (>90% coverage)
- [ ] Documentation complete
- [ ] No critical/high severity issues
- [ ] Code review approved
- [ ] Performance targets met

---

## Deliverables Summary

### Code Files (20+ files)
âœ… LDAP integration (4 files)
âœ… SAML/OAuth (4 files)
âœ… Encryption (3 files)
âœ… **NEW** System metrics collectors (4 files)
âœ… Tests (5 files)

### Database Schemas (4 new tables)
âœ… sn_sysstat_cpu
âœ… sn_sysstat_memusage
âœ… sn_sysstat_disks
âœ… sn_sysstat_network

### Documentation (6 files)
âœ… LDAP_INTEGRATION.md (2000+ words)
âœ… SAML_INTEGRATION.md (1000+ words)
âœ… OAUTH_INTEGRATION.md (1000+ words)
âœ… **NEW** SYSTEM_METRICS_COLLECTION.md (2000+ words)
âœ… **NEW** GRAFANA_SYSTEM_DASHBOARDS.md (1000+ words)

### Grafana Dashboards (3 new)
âœ… System Overview Dashboard
âœ… CPU & Load Dashboard
âœ… Memory & Disk Analysis Dashboard

---

## Related Documents

- **COMMUNITY_METRICS_ANALYSIS.md** - System metrics gap analysis
- **v3.3.0_IMPLEMENTATION_PLAN.md** - Overall plan
- **v3.3.0_WEEK1_SPRINT_BOARD.md** - Kubernetes (Week 1)
- **v3.3.0_WEEK2_SPRINT_BOARD.md** - HA/LB (Week 2)
- **v3.3.0_WEEK4_SPRINT_BOARD.md** - Audit & Backup (Week 4)

---

## Next Week Preview (Week 4)

**Phase**: Audit Logging & Backup/DR + Database Engine Metrics
**Duration**: 40 hours
**New System Metrics**: 18 additional metrics (BGWriter, Archiver, Replication)

### Week 4 Tasks
- Immutable audit logging system
- Automated backup & DR
- Background writer metrics
- WAL archiver metrics
- Replication monitoring

---

**Document Status**: ðŸš€ **UPDATED WITH SYSTEM METRICS - READY FOR EXECUTION**
**Last Updated**: February 26, 2026
**Total Hours Updated**: +45 hours for system metrics collection
**Total Week 3 Effort**: 140 hours (was 95h)
